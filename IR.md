# IR 规范---基本结构近似线性IR，非SSA，包含类型信息。打印格式是 JSON，便于各语言解析以及表示原有抽象语法树结构。其结构如下：- program_definition- function_definition- label- entity	- variable	- value- instruction	- variable_definition	- label_definition	- load	- store	- cjump	- jump	- call	- return	- bin	- uni## program_definition```JSON{	"object": "program_definition";	"name": "lalala",	"filename": "dsq.pas",	"line_number": 1,	"variablelist": [		{			"object": "variable_definition",			...		},		...	]	"functionlist": [		{			"object": "function_definition",			...		},		...	]	"labellist": [		{			"object": "label",			"pos": 2		},		...	]	"body": [		{			"object": "instruction",			...		},		...	]}```## fuction_definition```JSON{    "object": "function_definition",    "filename": "test.cl",    "line_number": 2,    "name": "main",    "type": "int32",	"parameterlist": [		{			"object": "entity",			"type": int32,			"name": "a"		},		...	],	"variablelist": [		{			"object": "variable_definition",			...		},		...	]	"labellist": [		{			"object": "label",			"pos": 2		},		...	]	"body": [		{			"object": "instruction",			"pos": 2		},		...	]}```## label```JSON{    "object": "label",    "name": "ruaruarua"	"pos": 2}```## entity### variable```JSON{    "object": "entity",    "type": "int8",    "name": "variable",	"variable": "a",	"const": true,}```### value```JSON{    "object": "entity",    "type": "int8",    "name": "value",	"value": 1}```### type在打印格式中均用一个字符串表示。`int8`8 bit 整数`int16`16 bit 整数`int32`32 bit 整数`int64`64 bit 整数`string`字符串`bool`布尔## instruction指令的打印格式为一个 JSON 对象，`type` 属性为 `instruction`，`name` 属性为此指令名称，每个操作数分别为一个属性，属性名即下文中的操作数名。以二元操作“>”为例```{	"object": "instruction",	"name": "bin",	"filename": "dsq.pas",	"line_number": 1,	"op": "S_GT",	"left": {		"object": "entity",		"type": "int32",		"name": "variable",		"variable": "a"	},	"right": {		"object": "entity",		"type": "int32",		"name": "value",		"value": 1	},	"value": {		"object": "entity",		"type": "int32",		"name": "variable",		"variable": "%cond1"	}}````variable_definition variablename var_type const value`定义变量，`variablename` 为string, `var_type` 为type `const` 为bool `value``label_definition labelname`定义标签，`labelname` 为string`load address value`取值，`address` 为entity, `value`为entity`store address value`取地址，`address` 为entity, `value`为entity`cjump cond thenLabel elseLabel`条件跳转，`cond` 为entity，`thenLabel` 和 `elseLabel` 均为label。`jump label`无条件跳转，`label` 为label`call functionname parameterlist value`调用表达式，`functionname` 为string，`parameterlist` 为entity的列表 `value` 为entity`return ret`返回，`ret` 为entity`bin op left right value`双目运算，`op` 为entity，`left` 和 `right` 均为entity, `value` 为entity`uni op variable value`单目运算，`op` 为entity，`variable` 为entity, `value` 为entity#### 运算符在打印格式中均用一个字符串表示。`ADD`加 `+``SUB`减 `-``MUL`乘 `*``S_DIV`有符号除 `/``U_DIV`无符号除 `/``S_MOD`有符号取模 `%``U_MOD`无符号取模 `%``BIT_LSHIFT`逻辑左移（无符号） `<<``BIT_RSHIFT`逻辑右移（无符号） `>>``ARITH_RSHIFT`算术右移（有符号） `>>``EQ`比较 `==``NEQ`比较 `!=``S_GT`有符号数值比较 `>``S_GTEQ`有符号数值比较 `>=``S_LT`有符号数值比较 `<``S_LTEQ`有符号数值比较 `<=``U_GT`无符号数值比较 `>``U_GTEQ`无符号数值比较 `>=``U_LT`无符号数值比较 `<``U_LTEQ`无符号数值比较 `<=``UMINUS`取反 `-``BIT_NOT`按位取反 `~``S_CAST`有符号数值类型转换`U_CAST`无符号数值类型转换`BIT_AND`位逻辑与 `&``BIT_OR`位逻辑或 `|``BIT_XOR`位逻辑异或 `^``NOT`逻辑非 `!`# IR 规范---高级结构翻译(样例)## if-else####example```if a>2 then a:=2 else a:=1;```####cond calculation```{	"object": "instruction",	"name": "variable_definition",	"variablename": "%cond1",	"var_type": int32}, {	"object": "instruction",	"name": "bin",	"op": "S_GT",	"left": {		"object": "entity",		"type": "int32",		"name": "variable",		"variable": "a"	},	"right": {		"object": "entity",		"type": "int32",		"name": "value",		"value": 1	},	"value": {		"object": "entity",		"type": "int32",		"name": "variable",		"variable": "%cond1"	}},```####cjump```{	"object": "instruction",	"name": "cjump",	"cond": {		"object": "entity",		"type": "int32",		"name": "variable",		"variable": "%cond1"	},	"thenlabel": "ifthenlabel1",	"elselabel": "ifelselabel1"},```####ifthenlabel definition```{	"object": "instruction",	"name": "label_definition",	"labelname": "ifthenlabel1"},```####then block```{	"object": "instruction",	"name": "store",	"address": {		"object": "entity",		"type": "int32*",		"name": "variable",		"variable": "a"	},	"value": {		"object": "entity",		"type": "int32",		"name": "value",		"value": 2	}}```####jump to end```{	"object": "instruction",	"name": "jump",	"label": "ifendlabel1"}```####ifelselabel definition```{	"object": "instruction",	"name": "label_definition",	"labelname": "ifelselabel1"}```####else block```{	"object": "instruction",	"name": "store",	"address": {		"object": "entity",		"type": "int32*",		"name": "variable",		"variable": "a"	},	"value": {		"object": "entity",		"type": "int32",		"name": "value",		"value": 1	}}```####endlabel definition```{	"object": "instruction",	"name": "label_definition",	"labelname": "ifendlabel1"}```## goto```pascalL:goto L;```example```JSON{	"object": "instruction",	"name": "label_definition",	"labelname": "L"}{	"object": "instruction",	"name": "jump",	"label": "L"}```## switch```pascalcase (grade) of	'A' : a:=1;	'B', 'C': a:=2;	'D' : a:=3;	'E' : a:=4;```####change into if_else```pascalif grade='A' then a:=1 else	if grade='B' or grade='C' then a:=2 else		if grade='D' then a:=3 else			if grade='E' then a"=4;```## for```pascalfor i:=2 to 10 dobegin	f := f + 1;end;```####change it into if_else and goto```pascali:=2Lstart:if i<=10 then f:=f+1 else goto Lend;i:=i+1;goto Lstart;Lend:```##repeat```pascala=0;repeat	a=a+1;until a>2;```####change it into if_else```pascala=0;Lstart:a=a+1;if a>2 then goto Lend else goto Lstart;Lend:```# a complete IR example输入一个数据x,判断这个数是否为素数```pascal1	program dsq;2	var n:longint;3		f:boolean;4	function prime(num: integer): boolean;5	var i:longint;6		g:boolean;7	begin8	for i:=2 to num do 9		if num mod i = 0 then g:=true;10	prime:=g;11	end12	begin13		n:=123;14		f:=false;15		f:=prime(n);16	end.``````JSON{	"object": "program_definition",	"name": "dsq",	"variablelist": [		{			"object": "entity",			"type": "bool",			"name": "variable",			"variable: "%1",			"const": false		}	],	"labellist": [],	"functionlist": [		{    		"object": "function_definition",			"filename": "dsq.pas",			"line_number": 4,    		"name": "prime",			"type": "bool",			"parameterlist": [				{					"object": "entity",					"type": "int32",					"name": "variable",					"variable": "num",					"const": false				}			],			"variablelist": [				{					"object": "entity",					"type": "int32",					"name": "variable",					"variable": "i",					"const": false				},				{					"object": "entity",					"type": "bool",					"name": "variable",					"variable": "g",					"const": false				},				{					"object": "entity",					"type": "bool",					"name": "variable",					"variable": "%1",					"const": false				}				{					"object": "entity",					"type": "int32",					"name": "variable",					"variable": "%2",					"const": false				},				{					"object": "entity",					"type": "int32",					"name": "variable",					"variable": "%3",					"const": false				},				{					"object": "entity",					"type": "int32",					"name": "variable",					"variable": "%4",					"const": false				}			]			"labellist": [				{					"object": "label",					"name": "forstartlabel1",					"pos": 2				},				{					"object": "label",					"name": "ifthenlabel1",					"pos": 6				},				{					"object": "label",					"name": "ifthenlabel2",					"pos": 12				},				{					"object": "label",					"name": "ifelselabel2",					"pos": 14				},				{					"object": "label",					"name": "ifendlabel2",					"pos": 15				},				{					"object": "label",					"name": "ifelselabel1",					"pos": 17				},				{					"object": "label",					"name": "ifendlabel1",					"pos": 19				},				{					"object": "label",					"name": "forendlabel1",					"pos": 24				}			]			"body": [				{					"object": "instruction",					"name": "store",					"filename": "dsq.pas",					"line_number": 8,					"address": {						"object": "entity",						"type": "int32",						"name": "variable",						"variable": "i",						"const": false					}					"value": {						"object": "entity",						"type": "int32",						"name": "value",						"value": "2"					}				},				{					"object": "instruction",					"name": "label_definition",					"filename": "dsq.pas",					"line_number": 8,					"labelname": "forstartlabel1"				},				{					"object": "instruction",					"name": "variable_definition",					"filename": "dsq.pas",					"line_number": 8,					"variablename": "%1",					"var_type": "bool"				}, 				{					"object": "instruction",					"name": "bin",					"filename": "dsq.pas",					"line_number": 8,					"op": "S_LT",					"left": {						"object": "entity",						"type": "int32",						"name": "variable",						"variable": "i",						"const": false					},					"right": {						"object": "entity",						"type": "int32",						"name": "variable",						"variable": "num",						"const": false					},					"value": {						"object": "entity",						"type": "bool",						"name": "variable",						"variable": "%1",						"const": false					}				},				{					"object": "instruction",					"name": "cjump",					"filename": "dsq.pas",					"line_number": 8,					"cond": {						"object": "entity",						"type": "bool",						"name": "variable",						"variable": "%1",						"const": false					},					"thenlabel": "ifthenlabel1",					"elselabel": "ifelselabel1"				},				{					"object": "instruction",					"name": "label_definition",					"filename": "dsq.pas",					"line_number": 8,					"labelname": "ifthenlabel1"				},				{					"object": "instruction",					"name": "variable_definition",					"filename": "dsq.pas",					"line_number": 9,					"variablename": "%2",					"var_type": "int32"				},				{					"object": "instruction",					"name": "bin",					"filename": "dsq.pas",					"line_number": 9,					"op": "U_MOD",					"left": {						"object": "entity",						"type": "int32",						"name": "variable",						"variable": "num",						"cosnt": false					},					"right": {						"object": "entity",						"type": "int32",						"name": "variable",						"variable": "i",						"const": false					},					"value": {						"object": "entity",						"type": "int32",						"name": "variable",						"variable": "%2",						"const": false					}				},				{					"object": "instruction",					"name": "variable_definition",					"filename": "dsq.pas",					"line_number": 9,					"variablename": "%3",					"var_type": "int32"				},				{					"object": "instruction",					"name": "bin",					"filename": "dsq.pas",					"line_number": 9,					"op": "EQ",					"left": {						"object": "entity",						"type": "int32",						"name": "variable",						"variable": "i",						"cosnt": false					},					"right": {						"object": "entity",						"type": "int32",						"name": "variable",						"variable": "%2",						"const": false					},					"value": {						"object": "entity",						"type": "int32",						"name": "variable",						"variable": "%3",						"const": false					}				},				{					"object": "instruction",					"name": "cjump",					"filename": "dsq.pas",					"line_number": 9,					"cond": {						"object": "entity",						"type": "bool",						"name": "variable",						"variable": "%3"					},					"thenlabel": "ifthenlabel2",					"elselabel": "ifelselabel2"				},				{					"object": "instruction",					"name": "label_definition",					"filename": "dsq.pas",					"line_number": 9,					"labelname": "ifthenlabel2"				},				{					"object": "instruction",					"name": "jump",					"filename": "dsq.pas",					"line_number": 9,					"label": "ifendlabel2"				},				{					"object": "instruction",					"name": "label_definition",					"filename": "dsq.pas",					"line_number": 9,					"labelname": "ifelselabel2"				},				{					"object": "instruction",					"name": "label_definition",					"filename": "dsq.pas",					"line_number": 9,					"labelname": "ifendlabel2"				},				{					"object": "instruction",					"name": "jump",					"filename": "dsq.pas",					"line_number": 8,					"label": "ifendlabel1"				},				{					"object": "instruction",					"name": "label_definition",					"filename": "dsq.pas",					"line_number": 8,					"labelname": "ifelselabel1"				},				{					"object": "instruction",					"name": "jump",					"filename": "dsq.pas",					"line_number": 8,					"label": "forendlabel1"				},				{					"object": "instruction",					"name": "label_definition",					"filename": "dsq.pas",					"line_number": 8,					"labelname": "ifendlabel1"				},				{					"object": "instruction",					"name": "variable_definition",					"filename": "dsq.pas",					"line_number": 8,					"variablename": "%4",					"var_type": "int32"				},				{					"object": "instruction",					"name": "bin",					"filename": "dsq.pas",					"line_number": 8,					"op": "ADD",					"left": {						"object": "entity",						"type": "int32",						"name": "variable",						"variable": "i",						"cosnt": false					},					"right": {						"object": "entity",						"type": "int32",						"name": "value",						"value": 1					},					"value": {						"object": "entity",						"type": "int32",						"name": "variable",						"variable": "%4",						"const": false					}				},				{					"object": "instruction",					"name": "store",					"filename": "dsq.pas",					"line_number": 8,					"address": {						"object": "entity",						"type": "int32",						"name": "variable",						"variable": "i",						"const": false					},					"value": {						"object": "entity",						"type": "int32",						"name": "variable",						"variable": "%4",						"const": false					}				},				{					"object": "instruction",					"name": "jump",					"filename": "dsq.pas",					"line_number": 8,					"label": "forstartlabel1"				},				{					"object": "instruction",					"name": "label_definition",					"filename": "dsq.pas",					"line_number": 8,					"labelname": "forendlabel1"				},				{					"object": "instruction",					"name": "return",					"filename": "dsq.pas",					"line_number": 10,					"ret": {						"object": "entity",						"type": "bool",						"name": "variable",						"variable": "g",						"const": false					}				}			]		}	]	"body": [		{			"object": "instruction",			"name": "store",			"filename": "dsq.pas",			"line_number": 13,			"address": {				"object": "entity",				"type": "int32",				"name": "variable",				"variable": "n",				"const": false			},			"value": {				"object": "entity",				"type": "int32",				"name": "value",				"value": 123			}		},		{			"object": "instruction",			"name": "store",			"filename": "dsq.pas",			"line_number": 14,			"address": {				"object": "entity",				"type": "bool",				"name": "variable",				"variable": "f",				"const": false			},			"value": {				"object": "entity",				"type": "bool",				"name": "value",				"value": false			}		},		{			"object": "instruction",			"name": "variable_definition",			"filename": "dsq.pas",			"line_number": 15,			"variablename": "%1",			"var_type": "bool"		},		{			"object": "instruction",			"name": "call",			"filename": "dsq.pas",			"line_number": 15,			"functionname": "prime"			"parameterlist": [				{					"object": "entity",					"type": "int32",					"name": "variable",					"variable": "n",					"const": false				}			],			"value": {				"object": "entity",				"type": "bool",				"name": "variable",				"variable": "%1",				"const": false			}		},		{			"object": "instruction",			"name": "store",			"filename": "dsq.pas",			"line_number": 15,			"address": {				"object": "entity",				"type": "bool",				"name": "variable",				"variable": "f",				"const": false			},			"value": {				"object": "entity",				"type": "bool",				"name": "variable",				"variable: "%1",				"const": false			}		}	]}```